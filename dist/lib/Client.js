"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const http = require("http");
const sd = require("string_decoder");
const EventEmitter = require("events");
const Communication_1 = require("./Communication");
const Session_1 = require("./Session");
const Torrent_1 = require("./Torrent");
const defaultOpts = {
    protocol: "http:",
    host: "127.0.0.1",
    path: "/transmission/rpc",
    port: 9091,
    username: null,
    password: null
};
const defaultFields = [
    "activityDate", "addedDate", "bandwidthPriority", "comment",
    "corruptEver", "creator", "dateCreated", "desiredAvailable",
    "doneDate", "downloadDir", "downloadedEver", "downloadLimit",
    "downloadLimited", "error", "errorString", "eta",
    "etaIdle", "files", "fileStats", "hashString",
    "haveUnchecked", "haveValid", "honorsSessionLimits",
    "isFinished", "isPrivate", "isStalled", "leftUntilDone",
    "magnetLink", "manualAnnounceTime", "maxConnectedPeers",
    "metadataPercentComplete", "name", "peer-limit", "peers",
    "peersConnected", "peersFrom", "peersGettingFromUs",
    "peersSendingToUs", "percentDone", "pieces", "pieceCount",
    "pieceSize", "priorities", "queuePosition", "rateDownload",
    "rateUpload", "recheckProgress", "secondsDownloading",
    "secondsSeeding", "seedIdleLimit", "seedIdleMode", "seedRatioLimit",
    "seedRatioMode", "sizeWhenDone", "startDate", "status",
    "trackers", "trackerStats", "totalSize", "torrentFile",
    "uploadedEver", "uploadLimit", "uploadLimited", "uploadRatio",
    "wanted", "webseeds", "webseedsSendingToUs"
];
class Client extends EventEmitter {
    constructor(sessionID = null, options = defaultOpts) {
        super();
        this.needsAuth = false;
        this.options = Object.assign({}, defaultOpts, options);
        if (sessionID)
            this.sessionID = sessionID;
        if (options.username) {
            this.needsAuth = true;
            this.auth = options.username + ":" + options.password;
        }
    }
    emit(event, data) { return super.emit(event, data); }
    on(event, listener) { return super.on(event, listener); }
    once(event, listener) { return super.once(event, listener); }
    addListener(event, listener) { return super.addListener(event, listener); }
    prependListener(event, listener) { return super.prependListener(event, listener); }
    prependOnceListener(event, listener) { return super.prependOnceListener(event, listener); }
    removeListener(event, listener) { return super.removeListener(event, listener); }
    convertIds(ids) {
        if (Array.isArray(ids) && ids.length == 0) {
            ids = null;
        }
        if (ids) {
            if (typeof ids === "object" && !Array.isArray(ids)) {
                ids = ids.id;
            }
            else if (Array.isArray(ids) && typeof ids[0] === "object") {
                ids = ids.map(elem => { return elem.id; });
            }
        }
        return ids;
    }
    getAllTorrents(fields = defaultFields, notFields = []) {
        return __awaiter(this, void 0, void 0, function* () {
            let torrents = yield this.getTorrent(null, fields, notFields);
            if (!torrents.length)
                return [torrents];
            else
                return torrents;
        });
    }
    getTorrent(ids, fields = defaultFields, notFields = []) {
        return __awaiter(this, void 0, void 0, function* () {
            let options = {};
            ids = this.convertIds(ids);
            if (ids)
                options.ids = ids;
            if (!fields)
                fields = defaultFields;
            if (!notFields)
                notFields = [];
            fields = fields.filter(item => !(~notFields.indexOf(item)));
            fields.push("id");
            fields.push("name");
            if (fields.indexOf("files") > -1) {
                fields.push("fileStats");
            }
            if (fields.indexOf("trackers") > -1) {
                fields.push("trackerStats");
            }
            options["fields"] = fields;
            let req = new Communication_1.TransmissionRequest("torrent-get", options);
            let res = yield this.sendRequest(req);
            let x = [];
            for (var i = 0; i < res.arguments["torrents"].length; i++) {
                var element = res.arguments["torrents"][i];
                let torrent = new Torrent_1.Torrent(this, fields).deserialize(element);
                x.push(torrent);
            }
            if (x.length == 1)
                return x[0];
            else
                return x;
        });
    }
    removeTorrent(ids, deleteData = false) {
        return __awaiter(this, void 0, void 0, function* () {
            let options = {};
            ids = this.convertIds(ids);
            if (ids)
                options.ids = ids;
            options["delete-local-data"] = deleteData;
            let req = new Communication_1.TransmissionRequest("torrent-remove", options);
            let res = yield this.sendRequest(req);
        });
    }
    addTorrent(file, options) {
        return __awaiter(this, void 0, void 0, function* () {
            options = Object.assign({}, options, { metainfo: file.toString('base64') });
            let req = new Communication_1.TransmissionRequest("torrent-add", options);
            let res = yield this.sendRequest(req);
            return res.arguments;
        });
    }
    setTorrentLocation(ids, options) {
        return __awaiter(this, void 0, void 0, function* () {
            ids = this.convertIds(ids);
            if (ids && !options.ids)
                options.ids = ids;
            let req = new Communication_1.TransmissionRequest("torrent-set-location", options);
            let res = yield this.sendRequest(req);
        });
    }
    renameTorrentPath(id, path, name) {
        return __awaiter(this, void 0, void 0, function* () {
            let ids = this.convertIds([id]);
            let req = new Communication_1.TransmissionRequest("torrent-rename-path", { ids, path, name });
            let res = yield this.sendRequest(req);
            return res.arguments;
        });
    }
    setTorrentProperties(ids, options) {
        return __awaiter(this, void 0, void 0, function* () {
            ids = this.convertIds(ids);
            if (ids && !options.ids)
                options.ids = ids;
            let req = new Communication_1.TransmissionRequest("torrent-set", options);
            let res = yield this.sendRequest(req);
        });
    }
    getSession() {
        return __awaiter(this, void 0, void 0, function* () {
            let req = new Communication_1.TransmissionRequest("session-get", {});
            let res = yield this.sendRequest(req);
            return new Session_1.Session(this).deserialize(res.arguments);
        });
    }
    setSessionProperties(options) {
        return __awaiter(this, void 0, void 0, function* () {
            let req = new Communication_1.TransmissionRequest("session-set", options);
            yield this.sendRequest(req);
        });
    }
    sendRequest(trequest) {
        return __awaiter(this, void 0, void 0, function* () {
            this.emit("request", trequest);
            return new Promise((resolve, reject) => {
                let failed = false;
                let reqopts = {};
                if (this.options.port)
                    reqopts.port = this.options.port;
                if (this.options.path)
                    reqopts.path = this.options.path;
                if (this.options.host)
                    reqopts.hostname = this.options.host;
                if (this.options.protocol)
                    reqopts.protocol = this.options.protocol;
                if (this.needsAuth)
                    reqopts.auth = this.auth;
                reqopts.method = "POST";
                reqopts.headers = {};
                if (this.sessionID)
                    reqopts.headers["x-transmission-session-id"] = this.sessionID;
                reqopts.headers["content-type"] = "application/json";
                const req = http.request(reqopts, res => {
                    if (res.statusCode < 200 || res.statusCode > 299) {
                        failed = true;
                        if (res.statusCode == 409) {
                            this.sessionID = res.headers["x-transmission-session-id"];
                            resolve(this.sendRequest(trequest));
                        }
                        else
                            reject(new Error("Failed to load: " + res.statusCode));
                    }
                    let data = "";
                    let decoder = new sd.StringDecoder("utf-8");
                    res.on("data", chunk => {
                        let textChunk = decoder.write(chunk);
                        data += textChunk;
                    });
                    res.on("end", () => {
                        if (!failed) {
                            let result = JSON.parse(data);
                            this.emit("response", result);
                            if (result.result != "success")
                                reject(result.result);
                            else
                                resolve(result);
                        }
                    });
                });
                req.on("error", err => reject(err));
                req.write(JSON.stringify(trequest));
                req.end();
            });
        });
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYi9DbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDZCQUE2QjtBQUM3QixxQ0FBcUM7QUFDckMsdUNBQXdDO0FBQ3hDLG1EQUE0RTtBQUM1RSx1Q0FBaUU7QUFDakUsdUNBQThIO0FBVzlILE1BQU0sV0FBVyxHQUFrQjtJQUMvQixRQUFRLEVBQUUsT0FBTztJQUNqQixJQUFJLEVBQUUsV0FBVztJQUNqQixJQUFJLEVBQUUsbUJBQW1CO0lBQ3pCLElBQUksRUFBRSxJQUFJO0lBQ1YsUUFBUSxFQUFFLElBQUk7SUFDZCxRQUFRLEVBQUUsSUFBSTtDQUNqQixDQUFBO0FBRUQsTUFBTSxhQUFhLEdBQWE7SUFDNUIsY0FBYyxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxTQUFTO0lBQzNELGFBQWEsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLGtCQUFrQjtJQUMzRCxVQUFVLEVBQUUsYUFBYSxFQUFFLGdCQUFnQixFQUFFLGVBQWU7SUFDNUQsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxLQUFLO0lBQ2hELFNBQVMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVk7SUFDN0MsZUFBZSxFQUFFLFdBQVcsRUFBRSxxQkFBcUI7SUFDbkQsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsZUFBZTtJQUN2RCxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsbUJBQW1CO0lBQ3ZELHlCQUF5QixFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsT0FBTztJQUN4RCxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsb0JBQW9CO0lBQ25ELGtCQUFrQixFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsWUFBWTtJQUN6RCxXQUFXLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxjQUFjO0lBQzFELFlBQVksRUFBRSxpQkFBaUIsRUFBRSxvQkFBb0I7SUFDckQs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QyxPQUFPLENBQUMsQ0FBQztvQkFDNUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSzt3QkFDaEIsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBUyxLQUFLLENBQUMsQ0FBQzt3QkFDN0MsSUFBSSxJQUFJLFNBQVMsQ0FBQztvQkFDdEIsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUU7d0JBQ1YsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOzRCQUNWLElBQUksTUFBTSxHQUF5QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQzs0QkFDOUIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxTQUFTLENBQUM7Z0NBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzs0QkFDdEQsSUFBSTtnQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ3pCLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDcEMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ2QsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0tBQUE7Q0FFSjtBQXBQRCx3QkFvUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQgKiBhcyBzZCBmcm9tIFwic3RyaW5nX2RlY29kZXJcIjtcbmltcG9ydCAqIGFzIEV2ZW50RW1pdHRlciAgZnJvbSBcImV2ZW50c1wiO1xuaW1wb3J0IHsgVHJhbnNtaXNzaW9uUmVxdWVzdCwgVHJhbnNtaXNzaW9uUmVzcG9uc2UgfSBmcm9tIFwiLi9Db21tdW5pY2F0aW9uXCI7XG5pbXBvcnQgeyBTZXNzaW9uLCBJU2Vzc2lvbiwgU2Vzc2lvblNldE9wdGlvbnMgfSBmcm9tIFwiLi9TZXNzaW9uXCI7XG5pbXBvcnQgeyBUb3JyZW50LCBJVG9ycmVudCwgU2V0VG9ycmVudE9wdGlvbnMsIFNldExvY2F0aW9uT3B0aW9ucywgUmVuYW1lVG9ycmVudFJlc3BvbnNlLCBBZGRUb3JyZW50T3B0aW9ucyB9IGZyb20gXCIuL1RvcnJlbnRcIlxuXG5leHBvcnQgaW50ZXJmYWNlIENsaWVudE9wdGlvbnMge1xuICAgIHByb3RvY29sPzogc3RyaW5nO1xuICAgIHBhdGg/OiBzdHJpbmc7XG4gICAgaG9zdD86IHN0cmluZztcbiAgICBwb3J0PzogbnVtYmVyO1xuICAgIHVzZXJuYW1lPzogc3RyaW5nO1xuICAgIHBhc3N3b3JkPzogc3RyaW5nO1xufVxuXG5jb25zdCBkZWZhdWx0T3B0czogQ2xpZW50T3B0aW9ucyA9IHtcbiAgICBwcm90b2NvbDogXCJodHRwOlwiLFxuICAgIGhvc3Q6IFwiMTI3LjAuMC4xXCIsXG4gICAgcGF0aDogXCIvdHJhbnNtaXNzaW9uL3JwY1wiLFxuICAgIHBvcnQ6IDkwOTEsXG4gICAgdXNlcm5hbWU6IG51bGwsXG4gICAgcGFzc3dvcmQ6IG51bGxcbn1cblxuY29uc3QgZGVmYXVsdEZpZWxkczogc3RyaW5nW10gPSBbXG4gICAgXCJhY3Rpdml0eURhdGVcIiwgXCJhZGRlZERhdGVcIiwgXCJiYW5kd2lkdGhQcmlvcml0eVwiLCBcImNvbW1lbnRcIixcbiAgICBcImNvcnJ1cHRFdmVyXCIsIFwiY3JlYXRvclwiLCBcImRhdGVDcmVhdGVkXCIsIFwiZGVzaXJlZEF2YWlsYWJsZVwiLFxuICAgIFwiZG9uZURhdGVcIiwgXCJkb3dubG9hZERpclwiLCBcImRvd25sb2FkZWRFdmVyXCIsIFwiZG93bmxvYWRMaW1pdFwiLFxuICAgIFwiZG93bmxvYWRMaW1pdGVkXCIsIFwiZXJyb3JcIiwgXCJlcnJvclN0cmluZ1wiLCBcImV0YVwiLFxuICAgIFwiZXRhSWRsZVwiLCBcImZpbGVzXCIsIFwiZmlsZVN0YXRzXCIsIFwiaGFzaFN0cmluZ1wiLFxuICAgIFwiaGF2ZVVuY2hlY2tlZFwiLCBcImhhdmVWYWxpZFwiLCBcImhvbm9yc1Nlc3Npb25MaW1pdHNcIixcbiAgICBcImlzRmluaXNoZWRcIiwgXCJpc1ByaXZhdGVcIiwgXCJpc1N0YWxsZWRcIiwgXCJsZWZ0VW50aWxEb25lXCIsXG4gICAgXCJtYWduZXRMaW5rXCIsIFwibWFudWFsQW5ub3VuY2VUaW1lXCIsIFwibWF4Q29ubmVjdGVkUGVlcnNcIixcbiAgICBcIm1ldGFkYXRhUGVyY2VudENvbXBsZXRlXCIsIFwibmFtZVwiLCBcInBlZXItbGltaXRcIiwgXCJwZWVyc1wiLFxuICAgIFwicGVlcnNDb25uZWN0ZWRcIiwgXCJwZWVyc0Zyb21cIiwgXCJwZWVyc0dldHRpbmdGcm9tVXNcIixcbiAgICBcInBlZXJzU2VuZGluZ1RvVXNcIiwgXCJwZXJjZW50RG9uZVwiLCBcInBpZWNlc1wiLCBcInBpZWNlQ291bnRcIixcbiAgICBcInBpZWNlU2l6ZVwiLCBcInByaW9yaXRpZXNcIiwgXCJxdWV1ZVBvc2l0aW9uXCIsIFwicmF0ZURvd25sb2FkXCIsXG4gICAgXCJyYXRlVXBsb2FkXCIsIFwicmVjaGVja1Byb2dyZXNzXCIsIFwic2Vjb25kc0Rvd25sb2FkaW5nXCIsXG4gICAgXCJzZWNvbmRzU2VlZGluZ1wiLCBcInNlZWRJZGxlTGltaXRcIiwgXCJzZWVkSWRsZU1vZGVcIiwgXCJzZWVkUmF0aW9MaW1pdFwiLFxuICAgIFwic2VlZFJhdGlvTW9kZVwiLCBcInNpemVXaGVuRG9uZVwiLCBcInN0YXJ0RGF0ZVwiLCBcInN0YXR1c1wiLFxuICAgIFwidHJhY2tlcnNcIiwgXCJ0cmFja2VyU3RhdHNcIiwgXCJ0b3RhbFNpemVcIiwgXCJ0b3JyZW50RmlsZVwiLFxuICAgIFwidXBsb2FkZWRFdmVyXCIsIFwidXBsb2FkTGltaXRcIiwgXCJ1cGxvYWRMaW1pdGVkXCIsIFwidXBsb2FkUmF0aW9cIixcbiAgICBcIndhbnRlZFwiLCBcIndlYnNlZWRzXCIsIFwid2Vic2VlZHNTZW5kaW5nVG9Vc1wiXG5dXG5cbmV4cG9ydCBjbGFzcyBDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgbmVlZHNBdXRoOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBhdXRoOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBzZXNzaW9uSUQ6IHN0cmluZztcbiAgICBvcHRpb25zOiBDbGllbnRPcHRpb25zO1xuICAgIGNvbnN0cnVjdG9yKHNlc3Npb25JRDogc3RyaW5nID0gbnVsbCwgb3B0aW9uczogQ2xpZW50T3B0aW9ucyA9IGRlZmF1bHRPcHRzKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRzLCBvcHRpb25zKTtcbiAgICAgICAgaWYgKHNlc3Npb25JRCkgdGhpcy5zZXNzaW9uSUQgPSBzZXNzaW9uSUQ7XG4gICAgICAgIGlmIChvcHRpb25zLnVzZXJuYW1lKSB7XG4gICAgICAgICAgICB0aGlzLm5lZWRzQXV0aCA9IHRydWVcbiAgICAgICAgICAgIHRoaXMuYXV0aCA9IG9wdGlvbnMudXNlcm5hbWUgKyBcIjpcIiArIG9wdGlvbnMucGFzc3dvcmQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBlbWl0KGV2ZW50OiBcInJlc3BvbnNlXCIsIGRhdGE6IFRyYW5zbWlzc2lvblJlc3BvbnNlKTogYm9vbGVhblxuICAgIGVtaXQoZXZlbnQ6IFwicmVxdWVzdFwiLCBkYXRhOiBUcmFuc21pc3Npb25SZXF1ZXN0KTogYm9vbGVhblxuICAgIGVtaXQoZXZlbnQ6IFwicmVzcG9uc2VcInxcInJlcXVlc3RcIiwgZGF0YTphbnkpOmJvb2xlYW4geyByZXR1cm4gc3VwZXIuZW1pdChldmVudCxkYXRhKSB9XG4gICAgb24oZXZlbnQ6IFwicmVzcG9uc2VcIiwgbGlzdGVuZXI6IChkYXRhOiBUcmFuc21pc3Npb25SZXNwb25zZSkgPT4gdm9pZCk6IHRoaXNcbiAgICBvbihldmVudDogXCJyZXF1ZXN0XCIsIGxpc3RlbmVyOiAoZGF0YTogVHJhbnNtaXNzaW9uUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXNcbiAgICBvbihldmVudDogXCJyZXNwb25zZVwifFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IGFueSkgPT4gdm9pZCk6IHRoaXMgeyByZXR1cm4gc3VwZXIub24oZXZlbnQsbGlzdGVuZXIpOyB9XG4gICAgb25jZShldmVudDogXCJyZXNwb25zZVwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlc3BvbnNlKSA9PiB2b2lkKTogdGhpc1xuICAgIG9uY2UoZXZlbnQ6IFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlcXVlc3QpID0+IHZvaWQpOiB0aGlzXG4gICAgb25jZShldmVudDogXCJyZXNwb25zZVwifFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IGFueSkgPT4gdm9pZCk6IHRoaXMgeyByZXR1cm4gc3VwZXIub25jZShldmVudCxsaXN0ZW5lcik7IH1cbiAgICBhZGRMaXN0ZW5lcihldmVudDogXCJyZXNwb25zZVwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlc3BvbnNlKSA9PiB2b2lkKTogdGhpc1xuICAgIGFkZExpc3RlbmVyKGV2ZW50OiBcInJlcXVlc3RcIiwgbGlzdGVuZXI6IChkYXRhOiBUcmFuc21pc3Npb25SZXF1ZXN0KSA9PiB2b2lkKTogdGhpc1xuICAgIGFkZExpc3RlbmVyKGV2ZW50OiBcInJlc3BvbnNlXCJ8XCJyZXF1ZXN0XCIsIGxpc3RlbmVyOiAoZGF0YTogYW55KSA9PiB2b2lkKTogdGhpcyB7IHJldHVybiBzdXBlci5hZGRMaXN0ZW5lcihldmVudCxsaXN0ZW5lcik7IH1cbiAgICBwcmVwZW5kTGlzdGVuZXIoZXZlbnQ6IFwicmVzcG9uc2VcIiwgbGlzdGVuZXI6IChkYXRhOiBUcmFuc21pc3Npb25SZXNwb25zZSkgPT4gdm9pZCk6IHRoaXNcbiAgICBwcmVwZW5kTGlzdGVuZXIoZXZlbnQ6IFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlcXVlc3QpID0+IHZvaWQpOiB0aGlzXG4gICAgcHJlcGVuZExpc3RlbmVyKGV2ZW50OiBcInJlc3BvbnNlXCJ8XCJyZXF1ZXN0XCIsIGxpc3RlbmVyOiAoZGF0YTogYW55KSA9PiB2b2lkKTogdGhpcyB7IHJldHVybiBzdXBlci5wcmVwZW5kTGlzdGVuZXIoZXZlbnQsbGlzdGVuZXIpOyB9XG4gICAgcHJlcGVuZE9uY2VMaXN0ZW5lcihldmVudDogXCJyZXNwb25zZVwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlc3BvbnNlKSA9PiB2b2lkKTogdGhpc1xuICAgIHByZXBlbmRPbmNlTGlzdGVuZXIoZXZlbnQ6IFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlcXVlc3QpID0+IHZvaWQpOiB0aGlzXG4gICAgcHJlcGVuZE9uY2VMaXN0ZW5lcihldmVudDogXCJyZXNwb25zZVwifFwicmVxdWVzdFwiLCBsaXN0ZW5lcjogKGRhdGE6IGFueSkgPT4gdm9pZCk6IHRoaXMgeyByZXR1cm4gc3VwZXIucHJlcGVuZE9uY2VMaXN0ZW5lcihldmVudCxsaXN0ZW5lcik7IH1cbiAgICByZW1vdmVMaXN0ZW5lcihldmVudDogXCJyZXNwb25zZVwiLCBsaXN0ZW5lcjogKGRhdGE6IFRyYW5zbWlzc2lvblJlc3BvbnNlKSA9PiB2b2lkKTogdGhpc1xuICAgIHJlbW92ZUxpc3RlbmVyKGV2ZW50OiBcInJlcXVlc3RcIiwgbGlzdGVuZXI6IChkYXRhOiBUcmFuc21pc3Npb25SZXF1ZXN0KSA9PiB2b2lkKTogdGhpc1xuICAgIHJlbW92ZUxpc3RlbmVyKGV2ZW50OiBcInJlc3BvbnNlXCJ8XCJyZXF1ZXN0XCIsIGxpc3RlbmVyOiAoZGF0YTogYW55KSA9PiB2b2lkKTogdGhpcyB7IHJldHVybiBzdXBlci5yZW1vdmVMaXN0ZW5lcihldmVudCxsaXN0ZW5lcik7IH1cblxuXG4gICAgcHJpdmF0ZSBjb252ZXJ0SWRzKHJlY2VudDogXCJyZWNlbnRseS1hY3RpdmVcIik6IHN0cmluZ1xuICAgIHByaXZhdGUgY29udmVydElkcyh0b3JyZW50OiBUb3JyZW50KTogbnVtYmVyXG4gICAgcHJpdmF0ZSBjb252ZXJ0SWRzKHRvcnJlbnRzOiBUb3JyZW50W10pOiBudW1iZXJbXVxuICAgIHByaXZhdGUgY29udmVydElkcyhpZDogbnVtYmVyKTogbnVtYmVyXG4gICAgcHJpdmF0ZSBjb252ZXJ0SWRzKGlkczogbnVtYmVyW10pOiBudW1iZXJbXVxuICAgIHByaXZhdGUgY29udmVydElkcyhoYXNoOiBzdHJpbmcpOiBzdHJpbmdcbiAgICBwcml2YXRlIGNvbnZlcnRJZHMoaGFzaGVzOiBzdHJpbmdbXSk6IHN0cmluZ1tdXG4gICAgcHJpdmF0ZSBjb252ZXJ0SWRzKGlkczogYW55KSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGlkcykgJiYgaWRzLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICBpZHMgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlkcykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBpZHMgPT09IFwib2JqZWN0XCIgJiYgIUFycmF5LmlzQXJyYXkoaWRzKSkge1xuICAgICAgICAgICAgICAgIGlkcyA9ICg8VG9ycmVudD5pZHMpLmlkO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGlkcykgJiYgdHlwZW9mIGlkc1swXSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgIGlkcyA9ICg8VG9ycmVudFtdPmlkcykubWFwKGVsZW0gPT4geyByZXR1cm4gZWxlbS5pZCB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIGVsc2UgaXMgbnVtYmVyW10gb3Igc3RyaW5nW10gb3IgbnVtYmVyIG9yIHN0cmluZ1xuXG4gICAgICAgIHJldHVybiBpZHM7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QWxsVG9ycmVudHMoZmllbGRzOiBzdHJpbmdbXSA9IGRlZmF1bHRGaWVsZHMsIG5vdEZpZWxkczogc3RyaW5nW10gPSBbXSk6IFByb21pc2U8VG9ycmVudFtdPiB7XG4gICAgICAgIGxldCB0b3JyZW50cyA9IGF3YWl0IHRoaXMuZ2V0VG9ycmVudChudWxsLCBmaWVsZHMsIG5vdEZpZWxkcyk7XG4gICAgICAgIGlmICghdG9ycmVudHMubGVuZ3RoKSByZXR1cm4gWzxhbnk+dG9ycmVudHMgYXMgVG9ycmVudF07XG4gICAgICAgIGVsc2UgcmV0dXJuIHRvcnJlbnRzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFRvcnJlbnQocmVjZW50OiBcInJlY2VudGx5LWFjdGl2ZVwiLCBmaWVsZHM/OiBzdHJpbmdbXSwgbm90RmllbGRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRvcnJlbnRbXT5cbiAgICAvLyBkb2Vzbid0IG1ha2Ugc2Vuc2UsIGJ1dCBtaWdodCBhcyB3ZWxsIGluY2x1ZGUgaXQgZm9yIGNvbnNpc3RlbmN5XG4gICAgYXN5bmMgZ2V0VG9ycmVudCh0b3JyZW50OiBUb3JyZW50LCBmaWVsZHM/OiBzdHJpbmdbXSwgbm90RmllbGRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRvcnJlbnQ+XG4gICAgYXN5bmMgZ2V0VG9ycmVudCh0b3JyZW50czogVG9ycmVudFtdLCBmaWVsZHM/OiBzdHJpbmdbXSwgbm90RmllbGRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRvcnJlbnRbXT5cbiAgICBhc3luYyBnZXRUb3JyZW50KGlkOiBudW1iZXIsIGZpZWxkcz86IHN0cmluZ1tdLCBub3RGaWVsZHM/OiBzdHJpbmdbXSk6IFByb21pc2U8VG9ycmVudD5cbiAgICBhc3luYyBnZXRUb3JyZW50KGlkczogbnVtYmVyW10sIGZpZWxkcz86IHN0cmluZ1tdLCBub3RGaWVsZHM/OiBzdHJpbmdbXSk6IFByb21pc2U8VG9ycmVudFtdPlxuICAgIGFzeW5jIGdldFRvcnJlbnQoaGFzaDogc3RyaW5nLCBmaWVsZHM/OiBzdHJpbmdbXSwgbm90RmllbGRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRvcnJlbnQ+XG4gICAgYXN5bmMgZ2V0VG9ycmVudChoYXNoZXM6IHN0cmluZ1tdLCBmaWVsZHM/OiBzdHJpbmdbXSwgbm90RmllbGRzPzogc3RyaW5nW10pOiBQcm9taXNlPFRvcnJlbnRbXT5cbiAgICBhc3luYyBnZXRUb3JyZW50KGlkczogYW55LCBmaWVsZHM6IHN0cmluZ1tdID0gZGVmYXVsdEZpZWxkcywgbm90RmllbGRzOiBzdHJpbmdbXSA9IFtdKSB7XG4gICAgICAgIGxldCBvcHRpb25zOiBhbnkgPSB7fTtcbiAgICAgICAgaWRzID0gdGhpcy5jb252ZXJ0SWRzKGlkcyk7XG4gICAgICAgIGlmIChpZHMpXG4gICAgICAgICAgICBvcHRpb25zLmlkcyA9IGlkcztcblxuICAgICAgICBpZiAoIWZpZWxkcykgZmllbGRzID0gZGVmYXVsdEZpZWxkcztcbiAgICAgICAgaWYgKCFub3RGaWVsZHMpIG5vdEZpZWxkcyA9IFtdO1xuXG4gICAgICAgIGZpZWxkcyA9IGZpZWxkcy5maWx0ZXIoaXRlbSA9PiAhKH5ub3RGaWVsZHMuaW5kZXhPZihpdGVtKSkpO1xuICAgICAgICBmaWVsZHMucHVzaChcImlkXCIpO1xuICAgICAgICBmaWVsZHMucHVzaChcIm5hbWVcIik7XG5cbiAgICAgICAgaWYgKGZpZWxkcy5pbmRleE9mKFwiZmlsZXNcIikgPiAtMSkge1xuICAgICAgICAgICAgLy8gd2UgY291bGQgZG8gYSBjaGVjayB3aGV0aGVyIGZpbGVTdGF0cyBkb2Vzbid0IGV4aXN0LCBidXQgdGhlIHNlcnZlciBkb2Vzbid0IGNhcmUgYWJvdXQgbXVsdGlwbGVzXG4gICAgICAgICAgICBmaWVsZHMucHVzaChcImZpbGVTdGF0c1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmaWVsZHMuaW5kZXhPZihcInRyYWNrZXJzXCIpID4gLTEpIHtcbiAgICAgICAgICAgIGZpZWxkcy5wdXNoKFwidHJhY2tlclN0YXRzXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgb3B0aW9uc1tcImZpZWxkc1wiXSA9IGZpZWxkcztcblxuICAgICAgICBsZXQgcmVxID0gbmV3IFRyYW5zbWlzc2lvblJlcXVlc3QoXCJ0b3JyZW50LWdldFwiLCBvcHRpb25zKTtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMuc2VuZFJlcXVlc3QocmVxKTtcbiAgICAgICAgbGV0IHg6IFRvcnJlbnRbXSA9IFtdO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzLmFyZ3VtZW50c1tcInRvcnJlbnRzXCJdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgZWxlbWVudCA9IDxJVG9ycmVudD5yZXMuYXJndW1lbnRzW1widG9ycmVudHNcIl1baV07XG4gICAgICAgICAgICBsZXQgdG9ycmVudCA9IG5ldyBUb3JyZW50KHRoaXMsIGZpZWxkcykuZGVzZXJpYWxpemUoZWxlbWVudCk7XG5cbiAgICAgICAgICAgIHgucHVzaCh0b3JyZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh4Lmxlbmd0aCA9PSAxKVxuICAgICAgICAgICAgcmV0dXJuIHhbMF07XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGFzeW5jIHJlbW92ZVRvcnJlbnQocmVjZW50OiBcInJlY2VudGx5LWFjdGl2ZVwiLCBkZWxldGVEYXRhPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD47XG4gICAgYXN5bmMgcmVtb3ZlVG9ycmVudCh0b3JyZW50OiBUb3JyZW50LCBkZWxldGVEYXRhPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD47XG4gICAgYXN5bmMgcmVtb3ZlVG9ycmVudCh0b3JyZW50czogVG9ycmVudFtdLCBkZWxldGVEYXRhPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD47XG4gICAgYXN5bmMgcmVtb3ZlVG9ycmVudChpZDogbnVtYmVyLCBkZWxldGVEYXRhPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD47XG4gICAgYXN5bmMgcmVtb3ZlVG9ycmVudChpZHM6IG51bWJlcltdLCBkZWxldGVEYXRhPzogYm9vbGVhbik6IFByb21pc2U8dm9pZD47XG4gICAgYXN5bmMgcmVtb3ZlVG9ycmVudChoYXNoOiBzdHJpbmcsIGRlbGV0ZURhdGE/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPjtcbiAgICBhc3luYyByZW1vdmVUb3JyZW50KGhhc2hlczogc3RyaW5nW10sIGRlbGV0ZURhdGE/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPjtcbiAgICBhc3luYyByZW1vdmVUb3JyZW50KGlkczogYW55LCBkZWxldGVEYXRhOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IG9wdGlvbnM6IGFueSA9IHt9O1xuICAgICAgICBpZHMgPSB0aGlzLmNvbnZlcnRJZHMoaWRzKTtcbiAgICAgICAgaWYgKGlkcylcbiAgICAgICAgICAgIG9wdGlvbnMuaWRzID0gaWRzO1xuICAgICAgICBvcHRpb25zW1wiZGVsZXRlLWxvY2FsLWRhdGFcIl0gPSBkZWxldGVEYXRhO1xuICAgICAgICBsZXQgcmVxID0gbmV3IFRyYW5zbWlzc2lvblJlcXVlc3QoXCJ0b3JyZW50LXJlbW92ZVwiLCBvcHRpb25zKTtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMuc2VuZFJlcXVlc3QocmVxKTtcbiAgICB9XG5cbiAgICBhc3luYyBhZGRUb3JyZW50KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IEFkZFRvcnJlbnRPcHRpb25zKTogUHJvbWlzZTxJVG9ycmVudD5cbiAgICBhc3luYyBhZGRUb3JyZW50KGZpbGU6IEJ1ZmZlciwgb3B0aW9ucz86IEFkZFRvcnJlbnRPcHRpb25zKTogUHJvbWlzZTxJVG9ycmVudD5cbiAgICBhc3luYyBhZGRUb3JyZW50KGZpbGU6IGFueSwgb3B0aW9ucz86IEFkZFRvcnJlbnRPcHRpb25zKTogUHJvbWlzZTxJVG9ycmVudD4ge1xuICAgICAgICBcbiAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHsgbWV0YWluZm86ICg8QnVmZmVyPmZpbGUpLnRvU3RyaW5nKCdiYXNlNjQnKX0pO1xuXG4gICAgICAgIGxldCByZXEgPSBuZXcgVHJhbnNtaXNzaW9uUmVxdWVzdChcInRvcnJlbnQtYWRkXCIsIG9wdGlvbnMpO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5zZW5kUmVxdWVzdChyZXEpO1xuICAgICAgICByZXR1cm4gPElUb3JyZW50PnJlcy5hcmd1bWVudHM7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0VG9ycmVudExvY2F0aW9uKHJlY2VudDogXCJyZWNlbnRseS1hY3RpdmVcIiwgb3B0aW9uczogU2V0TG9jYXRpb25PcHRpb25zKTogUHJvbWlzZTx2b2lkPlxuICAgIGFzeW5jIHNldFRvcnJlbnRMb2NhdGlvbih0b3JyZW50OiBUb3JyZW50LCBvcHRpb25zOiBTZXRMb2NhdGlvbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+XG4gICAgYXN5bmMgc2V0VG9ycmVudExvY2F0aW9uKHRvcnJlbnRzOiBUb3JyZW50W10sIG9wdGlvbnM6IFNldExvY2F0aW9uT3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50TG9jYXRpb24oaWQ6IG51bWJlciwgb3B0aW9uczogU2V0TG9jYXRpb25PcHRpb25zKTogUHJvbWlzZTx2b2lkPlxuICAgIGFzeW5jIHNldFRvcnJlbnRMb2NhdGlvbihpZHM6IG51bWJlcltdLCBvcHRpb25zOiBTZXRMb2NhdGlvbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+XG4gICAgYXN5bmMgc2V0VG9ycmVudExvY2F0aW9uKGhhc2g6IHN0cmluZywgb3B0aW9uczogU2V0TG9jYXRpb25PcHRpb25zKTogUHJvbWlzZTx2b2lkPlxuICAgIGFzeW5jIHNldFRvcnJlbnRMb2NhdGlvbihoYXNoZXM6IHN0cmluZ1tdLCBvcHRpb25zOiBTZXRMb2NhdGlvbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+XG4gICAgYXN5bmMgc2V0VG9ycmVudExvY2F0aW9uKGlkczogYW55LCBvcHRpb25zOiBTZXRMb2NhdGlvbk9wdGlvbnMpIHtcbiAgICAgICAgaWRzID0gdGhpcy5jb252ZXJ0SWRzKGlkcyk7XG4gICAgICAgIGlmIChpZHMgJiYgIW9wdGlvbnMuaWRzKVxuICAgICAgICAgICAgb3B0aW9ucy5pZHMgPSBpZHM7XG4gICAgICAgIGxldCByZXEgPSBuZXcgVHJhbnNtaXNzaW9uUmVxdWVzdChcInRvcnJlbnQtc2V0LWxvY2F0aW9uXCIsIG9wdGlvbnMpO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5zZW5kUmVxdWVzdChyZXEpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlbmFtZVRvcnJlbnRQYXRoKGhhc2g6IHN0cmluZywgcGF0aDogc3RyaW5nLCBuYW1lOiBzdHJpbmcpOiBQcm9taXNlPFJlbmFtZVRvcnJlbnRSZXNwb25zZT5cbiAgICBhc3luYyByZW5hbWVUb3JyZW50UGF0aCh0b3JyZW50OiBUb3JyZW50LCBwYXRoOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IFByb21pc2U8UmVuYW1lVG9ycmVudFJlc3BvbnNlPlxuICAgIGFzeW5jIHJlbmFtZVRvcnJlbnRQYXRoKGlkOiBudW1iZXIsIHBhdGg6IHN0cmluZywgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxSZW5hbWVUb3JyZW50UmVzcG9uc2U+XG4gICAgYXN5bmMgcmVuYW1lVG9ycmVudFBhdGgoaWQ6IGFueSwgcGF0aDogc3RyaW5nLCBuYW1lOiBzdHJpbmcpOiBQcm9taXNlPFJlbmFtZVRvcnJlbnRSZXNwb25zZT4ge1xuICAgICAgICBsZXQgaWRzID0gdGhpcy5jb252ZXJ0SWRzKFtpZF0pO1xuICAgICAgICBsZXQgcmVxID0gbmV3IFRyYW5zbWlzc2lvblJlcXVlc3QoXCJ0b3JyZW50LXJlbmFtZS1wYXRoXCIsIHsgaWRzLCBwYXRoLCBuYW1lIH0pO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5zZW5kUmVxdWVzdChyZXEpO1xuXG4gICAgICAgIHJldHVybiA8UmVuYW1lVG9ycmVudFJlc3BvbnNlPnJlcy5hcmd1bWVudHM7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0VG9ycmVudFByb3BlcnRpZXMocmVjZW50OiBcInJlY2VudGx5LWFjdGl2ZVwiLCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50UHJvcGVydGllcyh0b3JyZW50OiBUb3JyZW50LCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50UHJvcGVydGllcyh0b3JyZW50czogVG9ycmVudFtdLCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50UHJvcGVydGllcyhpZDogbnVtYmVyLCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50UHJvcGVydGllcyhpZHM6IG51bWJlcltdLCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucyk6IFByb21pc2U8dm9pZD5cbiAgICBhc3luYyBzZXRUb3JyZW50UHJvcGVydGllcyhoYXNoOiBzdHJpbmcsIG9wdGlvbnM6IFNldFRvcnJlbnRPcHRpb25zKTogUHJvbWlzZTx2b2lkPlxuICAgIGFzeW5jIHNldFRvcnJlbnRQcm9wZXJ0aWVzKGhhc2hlczogc3RyaW5nW10sIG9wdGlvbnM6IFNldFRvcnJlbnRPcHRpb25zKTogUHJvbWlzZTx2b2lkPlxuICAgIGFzeW5jIHNldFRvcnJlbnRQcm9wZXJ0aWVzKGlkczogYW55LCBvcHRpb25zOiBTZXRUb3JyZW50T3B0aW9ucykge1xuICAgICAgICBpZHMgPSB0aGlzLmNvbnZlcnRJZHMoaWRzKTtcbiAgICAgICAgaWYgKGlkcyAmJiAhb3B0aW9ucy5pZHMpXG4gICAgICAgICAgICBvcHRpb25zLmlkcyA9IGlkcztcbiAgICAgICAgbGV0IHJlcSA9IG5ldyBUcmFuc21pc3Npb25SZXF1ZXN0KFwidG9ycmVudC1zZXRcIiwgb3B0aW9ucyk7XG4gICAgICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLnNlbmRSZXF1ZXN0KHJlcSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0U2Vzc2lvbigpOiBQcm9taXNlPFNlc3Npb24+IHtcbiAgICAgICAgbGV0IHJlcSA9IG5ldyBUcmFuc21pc3Npb25SZXF1ZXN0KFwic2Vzc2lvbi1nZXRcIiwge30pO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5zZW5kUmVxdWVzdChyZXEpO1xuICAgICAgICByZXR1cm4gbmV3IFNlc3Npb24odGhpcykuZGVzZXJpYWxpemUoPElTZXNzaW9uPnJlcy5hcmd1bWVudHMpO1xuICAgIH1cblxuICAgIGFzeW5jIHNldFNlc3Npb25Qcm9wZXJ0aWVzKG9wdGlvbnM6IFNlc3Npb25TZXRPcHRpb25zKSB7XG4gICAgICAgIGxldCByZXEgPSBuZXcgVHJhbnNtaXNzaW9uUmVxdWVzdChcInNlc3Npb24tc2V0XCIsIG9wdGlvbnMpO1xuICAgICAgICBhd2FpdCB0aGlzLnNlbmRSZXF1ZXN0KHJlcSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2VuZFJlcXVlc3QodHJlcXVlc3Q6IFRyYW5zbWlzc2lvblJlcXVlc3QpOiBQcm9taXNlPFRyYW5zbWlzc2lvblJlc3BvbnNlPiB7XG4gICAgICAgIHRoaXMuZW1pdChcInJlcXVlc3RcIix0cmVxdWVzdCk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxUcmFuc21pc3Npb25SZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbGV0IGZhaWxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IHJlcW9wdHM6IGh0dHAuUmVxdWVzdE9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucG9ydCkgcmVxb3B0cy5wb3J0ID0gdGhpcy5vcHRpb25zLnBvcnQ7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnBhdGgpIHJlcW9wdHMucGF0aCA9IHRoaXMub3B0aW9ucy5wYXRoO1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5ob3N0KSByZXFvcHRzLmhvc3RuYW1lID0gdGhpcy5vcHRpb25zLmhvc3Q7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnByb3RvY29sKSByZXFvcHRzLnByb3RvY29sID0gdGhpcy5vcHRpb25zLnByb3RvY29sO1xuICAgICAgICAgICAgaWYgKHRoaXMubmVlZHNBdXRoKSByZXFvcHRzLmF1dGggPSB0aGlzLmF1dGg7XG5cbiAgICAgICAgICAgIHJlcW9wdHMubWV0aG9kID0gXCJQT1NUXCI7XG4gICAgICAgICAgICByZXFvcHRzLmhlYWRlcnMgPSB7fTtcbiAgICAgICAgICAgIGlmICh0aGlzLnNlc3Npb25JRClcbiAgICAgICAgICAgICAgICByZXFvcHRzLmhlYWRlcnNbXCJ4LXRyYW5zbWlzc2lvbi1zZXNzaW9uLWlkXCJdID0gdGhpcy5zZXNzaW9uSUQ7XG4gICAgICAgICAgICByZXFvcHRzLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPSBcImFwcGxpY2F0aW9uL2pzb25cIjtcblxuICAgICAgICAgICAgY29uc3QgcmVxID0gaHR0cC5yZXF1ZXN0KHJlcW9wdHMsIHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlIDwgMjAwIHx8IHJlcy5zdGF0dXNDb2RlID4gMjk5KSB7XG4gICAgICAgICAgICAgICAgICAgIGZhaWxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PSA0MDkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2Vzc2lvbklEID0gcmVzLmhlYWRlcnNbXCJ4LXRyYW5zbWlzc2lvbi1zZXNzaW9uLWlkXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLnNlbmRSZXF1ZXN0KHRyZXF1ZXN0KSlcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHJlamVjdChuZXcgRXJyb3IoXCJGYWlsZWQgdG8gbG9hZDogXCIgKyByZXMuc3RhdHVzQ29kZSkpXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGRhdGE6IHN0cmluZyA9IFwiXCI7XG4gICAgICAgICAgICAgICAgbGV0IGRlY29kZXIgPSBuZXcgc2QuU3RyaW5nRGVjb2RlcihcInV0Zi04XCIpO1xuICAgICAgICAgICAgICAgIHJlcy5vbihcImRhdGFcIiwgY2h1bmsgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdGV4dENodW5rID0gZGVjb2Rlci53cml0ZSg8QnVmZmVyPmNodW5rKTtcbiAgICAgICAgICAgICAgICAgICAgZGF0YSArPSB0ZXh0Q2h1bms7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmVzLm9uKFwiZW5kXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmYWlsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSA8VHJhbnNtaXNzaW9uUmVzcG9uc2U+SlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInJlc3BvbnNlXCIsIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnJlc3VsdCAhPSBcInN1Y2Nlc3NcIikgcmVqZWN0KHJlc3VsdC5yZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVxLm9uKFwiZXJyb3JcIiwgZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICAgICAgICAgIHJlcS53cml0ZShKU09OLnN0cmluZ2lmeSh0cmVxdWVzdCkpO1xuICAgICAgICAgICAgcmVxLmVuZCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbn0iXX0=